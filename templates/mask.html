<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Inpainting Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', Arial, sans-serif;
            background: #fff;
            min-height: 100vh;
            color: #000;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 56px;
            background: #fff;
            padding: 72px 0 40px 0;
            border-radius: 0;
            position: relative;
            box-shadow: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }

        .header h1 {
            font-size: 3.6em;
            margin-bottom: 0.2em;
            color: #000;
            font-weight: 900;
            letter-spacing: -2.5px;
            text-transform: none;
            line-height: 1.05;
        }
        .header .hero-divider {
            width: 80px;
            height: 5px;
            background: #FFD700;
            border-radius: 3px;
            margin: 18px auto 0 auto;
            opacity: 0.9;
        }
        .header p {
            font-size: 1.45em;
            color: #222;
            font-weight: 400;
            margin-top: 18px;
            letter-spacing: -0.2px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .back-button {
            position: absolute;
            left: 30px;
            top: 30px;
            background: #6B7280;
            color: #FFFFFF;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .back-button:hover {
            background: #9CA3AF;
        }

        .header h1 {
            font-size: 3.2em;
            margin-bottom: 10px;
            color: #000;
            font-weight: 900;
            letter-spacing: -2px;
            text-transform: none;
            line-height: 1.08;
        }

        .header p {
            font-size: 1.35em;
            color: #222;
            font-weight: 400;
            margin-top: 8px;
            letter-spacing: -0.2px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .controls-section {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 20px;
            color: #000;
            background: none;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            text-shadow: none;
            letter-spacing: -1px;
            text-align: center;
            text-transform: uppercase;
        }

        .mode-selector {
            display: flex;
            gap: 0;
            margin-bottom: 25px;
            background: #f8f8f8;
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);
            color: #222;
            font-weight: 700;
            box-shadow: 0 4px 16px rgba(255,215,0,0.13);
            border-radius: 10px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], select, textarea {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s ease;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #FFD700;
        }

        .drawing-tools {
            display: flex;
            gap: 15px;
            align-items: center;
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tool-btn {
            padding: 8px 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .tool-btn.active {
            background: #FFD700;
            border-color: #FFD700;
            color: #333;
        }

        .tool-btn:hover {
            border-color: #FFD700;
        }

        .brush-size {
            width: 120px;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .brush-size::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            cursor: pointer;
        }

        .brush-size::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #FFD700;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .brush-size-display {
            font-weight: 600;
            color: #333;
            min-width: 40px;
        }

        .opacity-slider {
            width: 100px;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .opacity-slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: #666;
            border-radius: 50%;
            cursor: pointer;
        }

        .opacity-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #666;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
            background: none;
        }

        .outpaint-controls {
            display: none;
            background: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .outpaint-controls.active {
            display: block;
        }

        .main-content {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
            align-items: flex-start;
        }

        .image-panel, .output-panel {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
            padding: 32px 32px 24px 32px;
            margin-bottom: 0;
            flex: 1 1 0;
            min-width: 0;
            min-height: 520px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .output-panel {
            justify-content: flex-start;
        }

        .panel-title {
            font-size: 1.5em;
            color: #000;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            width: 100%;
        }

        .image-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background: #fafafa;
            overflow: hidden;
        }

        .image-container.has-image {
            border: 2px solid #eee;
            background: white;
        }

        #uploadedImage {
            max-width: 100%;
            max-height: 600px;
            display: block;
        }

        #drawingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        #maskCanvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .result-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #f8f8f8;
            border-radius: 8px;
            color: #666;
            font-size: 16px;
        }

        .result-image {
            max-width: 100%;
            max-height: 600px;
            border-radius: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn, .back-btn, .download-btn, .action-btn {
            background: linear-gradient(135deg, #6B7280 0%, #9CA3AF 100%);
            color: #FFFFFF;
            border: 2px solid #6B7280;
            padding: 8px 22px;
            border-radius: 30px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.10);
            position: relative;
            overflow: hidden;
            margin-bottom: 8px;
            display: inline-block;
            text-decoration: none !important;
        }
        .btn::before, .back-btn::before, .download-btn::before, .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        .btn:hover::before, .back-btn:hover::before, .download-btn:hover::before, .action-btn:hover::before {
            left: 100%;
        }
        .btn:hover, .back-btn:hover, .download-btn:hover, .action-btn:hover {
            background: linear-gradient(135deg, #9CA3AF 0%, #6B7280 100%);
            color: #FFFFFF;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 40px rgba(107, 114, 128, 0.25);
            border-color: #9CA3AF;
        }
        .back-btn {
            position: absolute;
            left: 24px;
            top: 24px;
            z-index: 2;
            margin-bottom: 0;
        }

        .result-info {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
        }

        .result-info strong {
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #333;
            font-size: 16px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #FFD700;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fff5f5;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #fed7d7;
        }

        .success {
            background: #f0fff4;
            color: #38a169;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #c6f6d5;
        }

        /* Sidebar styles */
        .sidebar-left {
            min-height: 700px;
            position: sticky;
            top: 40px;
            background: #fff;
            border-right: none;
            padding: 32px 18px 32px 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 22px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            min-width: 220px;
            max-width: 260px;
            height: auto;
            gap: 18px;
        }
        .sidebar-title {
            font-size: 1.25em;
            font-weight: 800;
            color: #000;
            margin-bottom: 18px;
            letter-spacing: -0.5px;
        }
        .image-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
            width: 100%;
            align-items: center;
        }
        .image-thumb {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 14px;
            border: 2px solid #eee;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            opacity: 1;
            transform: none;
        }
        .image-thumb.selected, .image-thumb:hover {
            border: 2px solid #FFD700;
            box-shadow: 0 4px 16px rgba(255,215,0,0.13);
            transform: translateY(-2px) scale(1.04);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .drawing-tools {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .tool-group {
                justify-content: space-between;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .back-button {
                position: static;
                margin-bottom: 20px;
            }
            
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .drawing-tools {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .tool-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        .instructions-section {
            padding: 2.5rem 0 2rem 0;
            background: none;
            margin-bottom: 0;
        }
        .instructions-title {
            margin-bottom: 2.2rem;
            font-size: 2em;
            font-weight: 900;
            color: #000;
            text-align: center;
            letter-spacing: -1px;
        }
        .instructions-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            max-width: 900px;
            margin: 0 auto 2.5rem auto;
        }
        @media (max-width: 900px) {
            .instructions-steps {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        .instruction-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.04);
            padding: 2.2rem 2rem 1.5rem 2rem;
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            border: 2px solid #FFD700;
            min-height: 120px;
        }
        .instruction-number {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(255,215,0,0.10);
            flex-shrink: 0;
            margin-top: 2px;
        }
        .instruction-content {
            flex: 1;
        }
        .instruction-title {
            font-size: 1.15em;
            font-weight: 800;
            color: #000;
            margin-bottom: 0.3em;
        }
        .instruction-desc {
            font-size: 1.05em;
            color: #222;
            font-weight: 400;
            line-height: 1.5;
        }
        .instructions-tip {
            background: #fffbe6;
            border: 2px solid #FFD700;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(255,215,0,0.06);
            max-width: 900px;
            margin: 0 auto 0 auto;
            padding: 1.5rem 2rem 1.2rem 2rem;
            font-size: 1.08em;
            color: #222;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            gap: 0.7em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <a href="#" class="back-btn" id="backToDashboardBtn">← Back</a>
            <h1>AI Mask & Inpainting Studio</h1>
            <div class="hero-divider"></div>
            <p>Select, mask, and edit parts of your image with AI-powered precision</p>
        </header>
        
        <!-- SIDEBAR -->
        <div style="display: flex; gap: 40px; align-items: flex-start;">
            <aside class="sidebar-left">
                <div class="sidebar-title">House Images</div>
                <div class="image-list" id="imageList">
                    <!-- Thumbnails will be injected here -->
                </div>
            </aside>
            
            <!-- MAIN CONTENT -->
            <div style="flex: 1;">
                <!-- INSTRUCTIONS -->
                <section class="instructions-section">
                    <div class="instructions-title">How to Use</div>
                    <div class="instructions-steps">
                        <div class="instruction-card">
                            <div class="instruction-number">1</div>
                            <div class="instruction-content">
                                <div class="instruction-title">Select Image</div>
                                <div class="instruction-desc">Choose a house image from the sidebar or upload your own.</div>
                            </div>
                        </div>
                        <div class="instruction-card">
                            <div class="instruction-number">2</div>
                            <div class="instruction-content">
                                <div class="instruction-title">Draw Mask</div>
                                <div class="instruction-desc">Use the brush to mark areas you want to change or remove.</div>
                            </div>
                        </div>
                        <div class="instruction-card">
                            <div class="instruction-number">3</div>
                            <div class="instruction-content">
                                <div class="instruction-title">Describe Edit</div>
                                <div class="instruction-desc">Briefly describe what you want to add, remove, or change.</div>
                            </div>
                        </div>
                        <div class="instruction-card">
                            <div class="instruction-number">4</div>
                            <div class="instruction-content">
                                <div class="instruction-title">Apply & Download</div>
                                <div class="instruction-desc">Click 'Generate' to see the result, then download your new image.</div>
                            </div>
                        </div>
                    </div>
                    <div class="instructions-tip">
                        <div><b>Extend Canvas:</b> Use this to make your image bigger (add more space around it) before editing.</div>
                        <div><b>Modes:</b> <b>Mask Mode</b> is for changing or removing parts of the image. <b>Floor Mode</b> is for extending the floor or adding new areas to the bottom of the image.</div>
                    </div>
                </section>

                <div class="controls-section">
                    <h2 class="section-title">Mode & Settings</h2>
                    
                    <div class="mode-selector">
                        <button class="mode-btn active" data-mode="Manual Mode">Manual Mode</button>
                        <button class="mode-btn" data-mode="Floor Mode">Floor Mode</button>
                    </div>

                    <div class="outpaint-controls" id="outpaintControls">
                        <h3>Outpainting Settings</h3>
                        <button class="btn" id="outpaintBtn">Extend Canvas</button>
                    </div>

                    <div class="controls-grid">
                        <div class="control-group">
                            <label>Inpaint Prompt:</label>
                            <textarea id="prompt" placeholder="Describe what you want to generate in the masked area..." rows="3"></textarea>
                        </div>
                        <div class="control-group">
                            <label>Output Format:</label>
                            <select id="outputFormat">
                                <option value="webp">WebP</option>
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                    </div>

                    <div class="drawing-tools">
                        <div class="tool-group">
                            <label>Tool:</label>
                            <button class="tool-btn active" data-tool="brush">🖌️ Brush</button>
                            <button class="tool-btn" data-tool="eraser">🧹 Eraser</button>
                            <button class="tool-btn" data-tool="fill">🪣 Fill</button>
                        </div>
                        
                        <div class="tool-group">
                            <label>Size:</label>
                            <input type="range" id="brushSize" class="brush-size" min="5" max="50" value="20">
                            <span id="brushSizeDisplay" class="brush-size-display">20px</span>
                        </div>
                        
                        <div class="tool-group">
                            <label>Opacity:</label>
                            <input type="range" id="opacity" class="opacity-slider" min="0.1" max="1" step="0.1" value="0.6">
                            <span id="opacityDisplay">60%</span>
                        </div>
                        
                        <div class="tool-group">
                            <label>Color:</label>
                            <input type="color" id="colorPicker" class="color-picker" value="#FFD700">
                        </div>
                        
                        <div class="tool-group">
                            <button class="btn" id="clearCanvas">Clear All</button>
                            <button class="btn" id="undoBtn">↶ Undo</button>
                        </div>
                    </div>
                </div>

                <div class="main-content">
                    <div class="image-panel">
                        <div class="panel-title">Input Image</div>
                        <div class="image-container" id="imageContainer">
                            <img id="uploadedImage" style="display: none;">
                            <canvas id="drawingCanvas"></canvas>
                            <canvas id="maskCanvas" style="display:none;"></canvas>
                        </div>
                        <div class="action-buttons">
                            <button class="btn" id="inpaintBtn">Generate Inpainted Image</button>
                        </div>
                    </div>

                    <div class="output-panel">
                        <div class="panel-title">Output Result</div>
                        <div class="result-container" id="resultContainer">
                            <p>Generated image will appear here</p>
                        </div>
                        <div id="resultActions" class="action-buttons" style="display: none;">
                            <button class="btn" id="downloadBtn">Download Result</button>
                            <button class="btn" id="useAsInputBtn">Use as New Input</button>
                            <button class="btn" id="showMaskBtn" style="display:none;">Show Mask</button>
                        </div>
                        <div id="maskModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;justify-content:center;align-items:center;">
                            <div style="background:#fff;padding:24px 24px 12px 24px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.18);max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;">
                                <img id="modalMaskImg" src="" alt="Mask Preview" style="max-width:70vw;max-height:70vh;border:2px solid #FFD700;">
                                <button class="btn" id="closeMaskModal" style="margin-top:18px;">Close</button>
                            </div>
                        </div>
                        <div id="resultInfo" class="result-info" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let canvas, ctx, img, isDrawing = false;
        let maskCanvas, maskCtx;
        let sessionId = null;
        let currentMode = 'Manual Mode';
        let currentTool = 'brush';
        let undoStack = [];
        let currentResult = null;

        // Predefined values (removed from frontend)
        const defaultSettings = {
            // Floor mode settings
            extendHeight: 500,
            creativity: 0.1,
            outpaintPrompt: "natural sky, clouds, same architectural style",
            
            // General settings
            negativePrompt: "What you don't want to see...",
            seed: 0
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupCanvas();
            loadHouseImages(); // Load images for the sidebar
            
            // Load image from localStorage (set by main page)
            const imageData = localStorage.getItem('yourImageData');
            const imageSessionId = localStorage.getItem('yourImageSessionId');
            if (imageData) {
                displayImage(imageData);
                sessionId = imageSessionId;
            } else {
                alert('No image found. Please upload/select an image on the home page first.');
                window.location.href = '/';
            }
        });

        function setupEventListeners() {
            // Tool controls
            document.getElementById('brushSize').addEventListener('input', updateBrushSize);
            document.getElementById('opacity').addEventListener('input', updateOpacity);
            document.getElementById('colorPicker').addEventListener('change', updateColor);
            document.getElementById('clearCanvas').addEventListener('click', clearCanvas);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('inpaintBtn').addEventListener('click', handleInpaint);
            document.getElementById('outpaintBtn').addEventListener('click', handleOutpaint);
            document.getElementById('downloadBtn').addEventListener('click', downloadResult);
            document.getElementById('useAsInputBtn').addEventListener('click', useAsInput);
            document.getElementById('showMaskBtn').addEventListener('click', function() {
                if (currentResult && currentResult.mask_data) {
                    document.getElementById('modalMaskImg').src = currentResult.mask_data;
                    document.getElementById('maskModal').style.display = 'flex';
                }
            });
            document.getElementById('closeMaskModal').addEventListener('click', function() {
                document.getElementById('maskModal').style.display = 'none';
            });
            
            // Tool selector
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTool = this.dataset.tool;
                    updateCursor();
                });
            });
            
            // Mode selector
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    
                    const outpaintControls = document.getElementById('outpaintControls');
                    if (currentMode === 'Floor Mode') {
                        outpaintControls.classList.add('active');
                    } else {
                        outpaintControls.classList.remove('active');
                    }
                });
            });
        }

        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            maskCanvas = document.getElementById('maskCanvas');
            maskCtx = maskCanvas.getContext('2d');
            
            // Set up drawing events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            updateCursor();
        }

        function displayImage(imageData) {
            img = document.getElementById('uploadedImage');
            img.src = imageData;
            img.style.display = 'block';
            
            img.onload = function() {
                // Set canvas size to match displayed image
                canvas.width = img.offsetWidth;
                canvas.height = img.offsetHeight;
                canvas.style.width = img.offsetWidth + 'px';
                canvas.style.height = img.offsetHeight + 'px';
                // Set mask canvas size
                maskCanvas.width = img.offsetWidth;
                maskCanvas.height = img.offsetHeight;
                maskCanvas.style.width = img.offsetWidth + 'px';
                maskCanvas.style.height = img.offsetHeight + 'px';
                
                // Clear and setup canvases
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                maskCtx.fillStyle = '#000';
                maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
                setupDrawingContext();
                
                // Update container styling
                document.getElementById('imageContainer').classList.add('has-image');
                
                // Save initial state
                saveState();
            };
        }

        function setupDrawingContext() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over';
            updateColor();
            updateBrushSize();
            updateOpacity();
        }

        function updateCursor() {
            const cursors = {
                brush: 'crosshair',
                eraser: 'grab',
                fill: 'pointer'
            };
            canvas.style.cursor = cursors[currentTool] || 'crosshair';
        }

        function updateColor() {
            const color = document.getElementById('colorPicker').value;
            const opacity = document.getElementById('opacity').value;
            const rgba = hexToRgba(color, opacity);
            ctx.fillStyle = rgba;
            ctx.strokeStyle = rgba;
        }

        function updateBrushSize() {
            const size = document.getElementById('brushSize').value;
            document.getElementById('brushSizeDisplay').textContent = size + 'px';
            ctx.lineWidth = parseInt(size);
        }

        function updateOpacity() {
            const opacity = document.getElementById('opacity').value;
            document.getElementById('opacityDisplay').textContent = Math.round(opacity * 100) + '%';
            updateColor();
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function saveState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > 20) {
                undoStack.shift();
            }
        }

        function undo() {
            if (undoStack.length > 1) {
                undoStack.pop(); // Remove current state
                const previousState = undoStack[undoStack.length - 1];
                const tempImg = new Image();
                tempImg.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(tempImg, 0, 0);
                };
                tempImg.src = previousState;
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                maskCtx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
                maskCtx.globalCompositeOperation = 'source-over';
            }
            
            if (currentTool === 'fill') {
                floodFill(x, y);
                saveState();
                return;
            }
            
            // Draw on visible canvas (yellow)
            ctx.beginPath();
            ctx.arc(x, y, ctx.lineWidth / 2, 0, Math.PI * 2);
            ctx.fill();
            // Draw on mask canvas (white)
            maskCtx.beginPath();
            maskCtx.arc(x, y, ctx.lineWidth / 2, 0, Math.PI * 2);
            maskCtx.fillStyle = '#fff';
            maskCtx.globalAlpha = 1.0;
            maskCtx.fill();
            saveState();
        }

        function draw(e) {
            if (!isDrawing || currentTool === 'fill') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left;
            const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top;
            
            // Draw on visible canvas (yellow)
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(x, y, ctx.lineWidth / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(x, y);
            // Draw on mask canvas (white)
            maskCtx.lineTo(x, y);
            maskCtx.strokeStyle = '#fff';
            maskCtx.lineWidth = ctx.lineWidth;
            maskCtx.stroke();
            maskCtx.beginPath();
            maskCtx.arc(x, y, ctx.lineWidth / 2, 0, Math.PI * 2);
            maskCtx.fillStyle = '#fff';
            maskCtx.globalAlpha = 1.0;
            maskCtx.fill();
            maskCtx.beginPath();
            maskCtx.moveTo(x, y);
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
                ctx.globalCompositeOperation = 'source-over';
                maskCtx.beginPath();
                maskCtx.globalCompositeOperation = 'source-over';
            }
        }

        function floodFill(x, y) {
            // Simple flood fill implementation
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const color = document.getElementById('colorPicker').value;
            const opacity = document.getElementById('opacity').value;
            const rgba = hexToRgba(color, opacity);
            
            // This is a simplified flood fill - in production you'd want a more robust implementation
            ctx.fillStyle = rgba;
            ctx.fillRect(x - 10, y - 10, 20, 20);
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            maskCtx.fillStyle = '#000';
            maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
            saveState();
        }

        function handleOutpaint() {
            // Get the input image as a blob
            const uploadedImage = document.getElementById('uploadedImage');
            const imageUrl = uploadedImage.src;
            console.log('[OUTPAINT DEBUG] handleOutpaint called');
            console.log('[OUTPAINT DEBUG] imageUrl:', imageUrl);
            fetch(imageUrl)
                .then(res => res.blob())
                .then(imageBlob => {
                    console.log('[OUTPAINT DEBUG] imageBlob:', imageBlob);
                    const formData = new FormData();
                    formData.append('image', imageBlob, 'input.png');
                    formData.append('extend_height', defaultSettings.extendHeight);
                    formData.append('creativity', defaultSettings.creativity);
                    formData.append('outpaint_prompt', defaultSettings.outpaintPrompt);
                    formData.append('seed', defaultSettings.seed);
                    formData.append('output_format', document.getElementById('outputFormat').value);
                    for (let pair of formData.entries()) {
                        console.log('[OUTPAINT DEBUG] FormData:', pair[0], pair[1]);
                    }
                    showResult('Extending canvas...', 'loading');
                    fetch('/outpaint', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        console.log('[OUTPAINT DEBUG] /outpaint response:', response);
                        return response.json();
                    })
                    .then(data => {
                        console.log('[OUTPAINT DEBUG] /outpaint data:', data);
                        if (data.success) {
                            displayImage(data.image_data);
                            showResult('Canvas extended successfully! Now you can draw on the new area.', 'success');
                        } else {
                            showResult('Outpaint failed: ' + data.detail, 'error');
                        }
                    })
                    .catch(error => {
                        console.log('[OUTPAINT DEBUG] /outpaint error:', error);
                        showResult('Outpaint error: ' + error.message, 'error');
                    });
                });
        }

        function handleInpaint() {
            // Get the input image as a blob
            const uploadedImage = document.getElementById('uploadedImage');
            const imageUrl = uploadedImage.src;
            console.log('[INPAINT DEBUG] handleInpaint called');
            console.log('[INPAINT DEBUG] imageUrl:', imageUrl);
            fetch(imageUrl)
                .then(res => res.blob())
                .then(imageBlob => {
                    console.log('[INPAINT DEBUG] imageBlob:', imageBlob);
                    // Get the mask from the mask canvas as a blob
                    maskCanvas.toBlob(function(maskBlob) {
                        console.log('[INPAINT DEBUG] maskBlob:', maskBlob);
                        const formData = new FormData();
                        formData.append('image', imageBlob, 'input.png');
                        formData.append('mask', maskBlob, 'mask.png');
                        formData.append('prompt', document.getElementById('prompt').value);
                        formData.append('negative_prompt', defaultSettings.negativePrompt);
                        formData.append('seed', defaultSettings.seed);
                        formData.append('output_format', document.getElementById('outputFormat').value);
                        formData.append('mode', currentMode);
                        for (let pair of formData.entries()) {
                            console.log('[INPAINT DEBUG] FormData:', pair[0], pair[1]);
                        }
                        showResult('Generating inpainted image...', 'loading');
                        fetch('/inpaint', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => {
                            console.log('[INPAINT DEBUG] /inpaint response:', response);
                            return response.json();
                        })
                        .then(data => {
                            console.log('[INPAINT DEBUG] /inpaint data:', data);
                            if (data.success) {
                                currentResult = data;
                                displayResult(data.image_data, data.mask_data);
                                showResultInfo(data);
                            } else {
                                showResult('Inpaint failed: ' + data.detail, 'error');
                            }
                        })
                        .catch(error => {
                            console.log('[INPAINT DEBUG] /inpaint error:', error);
                            showResult('Inpaint error: ' + error.message, 'error');
                        });
                    }, 'image/png');
                });
        }

        function showResult(content, type) {
            const container = document.getElementById('resultContainer');
            
            if (type === 'loading') {
                container.innerHTML = `<div class="loading">${content}</div>`;
            } else if (type === 'error') {
                container.innerHTML = `<div class="error">${content}</div>`;
            } else {
                container.innerHTML = `<div class="success">${content}</div>`;
            }
            
            document.getElementById('resultActions').style.display = 'none';
            document.getElementById('resultInfo').style.display = 'none';
        }

        function displayResult(imageData, maskData) {
            const container = document.getElementById('resultContainer');
            let html = `<img src="${imageData}" alt="Generated Result" class="result-image">`;
            // Remove inline mask preview: do not append mask image or 'Mask Used' text here
            container.innerHTML = html;
            document.getElementById('resultActions').style.display = 'flex';
            // Show/hide Show Mask button
            if (maskData) {
                document.getElementById('showMaskBtn').style.display = 'inline-block';
            } else {
                document.getElementById('showMaskBtn').style.display = 'none';
            }
        }

        function showResultInfo(data) {
            const info = document.getElementById('resultInfo');
            info.innerHTML = `
                <strong>Seed:</strong> ${data.seed}<br>
                <strong>Filename:</strong> ${data.filename}
            `;
            info.style.display = 'block';
        }

        function downloadResult() {
            if (currentResult) {
                const a = document.createElement('a');
                a.href = currentResult.image_data;
                a.download = currentResult.filename;
                a.click();
            }
            // Download mask if available
            if (currentResult && currentResult.mask_data) {
                const a = document.createElement('a');
                a.href = currentResult.mask_data;
                a.download = 'mask.png';
                a.click();
            }
        }

        function useAsInput() {
            if (currentResult) {
                displayImage(currentResult.image_data);
                clearCanvas();
                document.getElementById('resultContainer').innerHTML = '<p>Generated image will appear here</p>';
                document.getElementById('resultActions').style.display = 'none';
                document.getElementById('resultInfo').style.display = 'none';
            }
        }

        function goBackToChatbot() {
            localStorage.setItem('skipPassword', '1');
            window.location.href = '/';
        }

        document.getElementById('backToDashboardBtn').addEventListener('click', function(e) {
            e.preventDefault();
            sessionStorage.setItem('showDashboardOnce', '1');
            window.location.href = '/';
        });

        // Add sidebar functionality
        function loadHouseImages() {
            fetch('/list-house-images')
                .then(res => res.json())
                .then(data => {
                    const imageList = document.getElementById('imageList');
                    imageList.innerHTML = '';
                    if (data.images && data.images.length > 0) {
                        data.images.forEach((imgUrl, index) => {
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.alt = 'House Image ' + (index + 1);
                            img.className = 'image-thumb';
                            img.dataset.index = index;

                            img.addEventListener('click', function() {
                                document.querySelectorAll('.image-thumb').forEach(thumb => {
                                    thumb.classList.remove('selected');
                                });
                                this.classList.add('selected');
                                
                                // Set the selected image as input for masking
                                displayImage(this.src);
                                console.log('Selected image for masking:', this.src);
                            });

                            imageList.appendChild(img);
                        });
                        animateImagesIn();
                    } else {
                        imageList.innerHTML = '<div style="color:#aaa;font-size:1rem;margin-top:24px;">No images found</div>';
                    }
                })
                .catch(() => {
                    const imageList = document.getElementById('imageList');
                    imageList.innerHTML = '<div style="color:#aaa;font-size:1rem;margin-top:24px;">Failed to load images</div>';
                });
        }

        function animateImagesIn() {
            const images = document.querySelectorAll('.image-thumb');
            images.forEach((img, index) => {
                setTimeout(() => {
                    img.classList.add('slide-in');
                }, index * 100);
            });
        }
    </script>
</body>
</html>